<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AstroBridge - Multi-Chain Bridge</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.6.9/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;font-family:'Orbitron',sans-serif;}
body{background:radial-gradient(circle at 20% 20%,#050029,#2E007A);color:#fff;min-height:100vh;display:flex;justify-content:center;align-items:flex-start;padding:2rem 1rem;overflow-x:hidden;}
.container{background:rgba(255,255,255,0.05);backdrop-filter:blur(20px);border-radius:25px;padding:2rem;width:100%;max-width:720px;text-align:center;box-shadow:0 0 50px rgba(255,69,0,0.2);position:relative;z-index:2;}
.back-btn{text-align:left;margin-bottom:1rem;}
.back-btn a{display:inline-flex;align-items:center;gap:.3rem;color:#ff8c00;text-decoration:none;font-weight:bold;font-size:.9rem;transition:.3s;}
.back-btn a:hover{color:#ff4500;}
h1{font-size:2.2rem;background:linear-gradient(90deg,#ff4500,#ff8c00,#ff69b4);-webkit-background-clip:text;color:transparent;margin-bottom:.5rem;animation:glow 3s infinite alternate;}
@keyframes glow{0%{text-shadow:0 0 5px #ff4500,0 0 10px #ff4500;}100%{text-shadow:0 0 20px #ff69b4,0 0 40px #ff8c00;}}
.group{text-align:left;margin-bottom:1rem;}
.group label{display:block;margin-bottom:.3rem;color:#FFA07A;font-size:.9rem;}
input,select{width:100%;padding:.8rem 1rem;border-radius:12px;border:1px solid rgba(255,140,0,0.3);background:rgba(50,20,10,0.6);color:#fff;outline:none;font-size:1rem;transition:.3s;}
input:focus,select:focus{border-color:#ff8c00;box-shadow:0 0 10px #ff4500;}
button{width:100%;padding:1rem;margin-top:.5rem;border:none;border-radius:15px;font-size:1rem;font-weight:600;cursor:pointer;background:linear-gradient(90deg,#ff4500,#ff8c00);color:#fff;transition:.3s;}
button:disabled{opacity:.5;cursor:not-allowed;background:#666;}
.status{min-height:1.4rem;margin-top:.5rem;font-size:.95rem;}
.success{color:#32CD32;}
.warn{color:#FFA500;}
.error{color:#FF6347;}
.balance{margin-top:.3rem;color:#FF8C00;font-size:.9rem;}
.rocket{position:absolute;bottom:10px;left:50%;transform:translateX(-50%) translateY(0);width:30px;height:60px;background:#ff4500;border-radius:15px 15px 0 0;box-shadow:0 0 15px #ff8c00;transition: transform 2s ease-in-out;z-index:1;}
.rocket.launch{transform:translateX(-50%) translateY(-300px);}
#txChart{margin-top:15px;background:rgba(0,0,0,0.2);border-radius:10px;padding:10px;}
.queueList,#historyList,#feeInfo,#pointsInfo,#rewardList{margin-top:10px;font-size:.85rem;color:#FFA07A;max-height:120px;overflow-y:auto;text-align:left;padding:5px;}
.ai-panel{margin:15px 0;padding:12px;background:rgba(255,140,0,0.1);border-radius:12px;text-align:left;}
.ai-status{font-size:1rem;font-weight:600;color:#ff8c00;margin-bottom:8px;}
.ai-suggestions{font-size:.85rem;color:#FFA07A;}
.ai-suggestions .warn{color:#ff4500;}
</style>
</head>
<body>
<div class="container">
  <div class="back-btn"><a href="/"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M19 12H5M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>Back to Home</a></div>
  <h1>AstroBridge</h1>
  <p class="status" id="walletStatus">Wallet not connected</p>
  <button id="connectBtn">Connect Wallet</button>

  <div class="ai-panel">
    <div id="aiStatus" class="ai-status">ðŸ¤– AI Ready</div>
    <div id="aiSuggestions" class="ai-suggestions"></div>
  </div>

  <div class="group"><label>Token</label><select id="tokenSelect"></select><div class="balance" id="tokenBalance">--</div></div>
  <div class="group"><label>From Chain</label><select id="fromChain"></select></div>
  <div class="group"><label>To Chain</label><select id="toChain"></select></div>
  <div class="group"><label>Amount</label><input id="amount" type="number" step="0.001" min="0.001" placeholder="0.001"/></div>
  <div class="group"><label>Slippage (%)</label><input id="slippage" type="number" step="0.1" min="0.1" max="5" value="1"/></div>

  <div id="pricePreview">Estimated USD Value: --</div>
  <div id="feeInfo">Estimated Fee: --</div>
  <div id="kycStatus">KYC: Not Verified</div>
  <div id="rewardList">NFT Rewards: None</div>
  <div class="status" id="status"></div>
  <button id="bridgeBtn" disabled>Cross-Chain Transfer</button>

  <canvas id="txChart" height="120"></canvas>
  <div class="queueList" id="queueList">Queue: Empty</div>
  <div class="queueList" id="historyList">History: Empty</div>
  <div class="queueList" id="pointsInfo">Points: 0</div>

  <div class="rocket" id="rocket"></div>
</div>

<script>
const API_BASE="/api"; // æ”¹æˆä½ æœåŠ¡å™¨ API åœ°å€
let provider, signer, account, tokenContract, txQueue=[], txHistory=[], points=0, txChart=null;

const CHAINS=[{id:1,name:"Ethereum"},{id:56,name:"BSC"},{id:137,name:"Polygon"},{id:42161,name:"Arbitrum"},{id:10,name:"Optimism"},{id:43114,name:"Avalanche"},{id:250,name:"Fantom"}];
const TOKENS={ASTRO:"0xa513E6E4b8f2a923D98304ec87F64353C4D5C853",USDT:"0xTestUSDT",USDC:"0xTestUSDC"};

const DOM={
  walletStatus:document.getElementById('walletStatus'),
  connectBtn:document.getElementById('connectBtn'),
  bridgeBtn:document.getElementById('bridgeBtn'),
  status:document.getElementById('status'),
  tokenSelect:document.getElementById('tokenSelect'),
  fromChain:document.getElementById('fromChain'),
  toChain:document.getElementById('toChain'),
  amount:document.getElementById('amount'),
  slippage:document.getElementById('slippage'),
  tokenBalance:document.getElementById('tokenBalance'),
  rocket:document.getElementById('rocket'),
  pricePreview:document.getElementById('pricePreview'),
  feeInfo:document.getElementById('feeInfo'),
  queueList:document.getElementById('queueList'),
  historyList:document.getElementById('historyList'),
  pointsInfo:document.getElementById('pointsInfo'),
  rewardList:document.getElementById('rewardList'),
  aiStatus:document.getElementById('aiStatus'),
  aiSuggestions:document.getElementById('aiSuggestions'),
  kycStatus:document.getElementById('kycStatus'),
  txChart:document.getElementById('txChart')
};

// ===== AI æ£€æŸ¥ =====
class BridgeAI {
  constructor(){this.reset();}
  reset(){this.status="ðŸ¤– AI Ready";this.suggestions=[];this.warnings=[];}
  async runCheck(data){
    this.reset();this.status="ðŸ¤– Analyzing...";
    this.checkWallet(data.account);
    this.checkBalance(data.balance,data.amount);
    this.checkChain(data.from,data.to);
    this.checkSlippage(data.slippage);
    this.status=`ðŸ¤– ${this.warnings.length?'âš ï¸ Attention':'âœ… Safe'}`;
    return {status:this.status,suggestions:this.suggestions,warnings:this.warnings};
  }
  checkWallet(acc){acc?this.suggestions.push(`âœ… Connected: ${acc.slice(0,6)}...`):this.warnings.push("âŒ Wallet not connected");}
  checkBalance(bal,amt){if(bal && parseFloat(amt)>parseFloat(bal)){this.warnings.push(`âš ï¸ Amount exceeds balance (${bal})`);}else if(bal){this.suggestions.push(`âœ… Balance: ${bal}`);}}
  checkChain(from,to){from===to?this.warnings.push("âš ï¸ Same chain not allowed"):this.suggestions.push(`âœ… Cross-chain: ${from} â†’ ${to}`);}
  checkSlippage(s){s>1?this.warnings.push(`âš ï¸ Slippage (${s}%) high, â‰¤1% recommended`):this.suggestions.push(`âœ… Slippage (${s}%) ok`);}
}
const bridgeAI=new BridgeAI();
function showAI(report){
  DOM.aiStatus.textContent=report.status;
  let html='';
  report.suggestions.forEach(s=>html+=`<div>${s}</div>`);
  report.warnings.forEach(w=>html+=`<div class="warn">${w}</div>`);
  DOM.aiSuggestions.innerHTML=html;
}

// ===== Wallet & LiFi æ¨¡æ‹Ÿ =====
DOM.connectBtn.onclick=async()=>{
  if(!window.ethereum){DOM.walletStatus.textContent="MetaMask not found";DOM.walletStatus.className="status error";return;}
  DOM.connectBtn.disabled=true;
  try{
    [account]=await window.ethereum.request({method:'eth_requestAccounts'});
    provider=new ethers.providers.Web3Provider(window.ethereum);
    signer=provider.getSigner();
    populateChainsAndTokens(); await updateBalance(); await updateAI();
    DOM.walletStatus.textContent=`Connected: ${account.slice(0,6)}...${account.slice(-4)}`; DOM.walletStatus.className="status success";
    DOM.bridgeBtn.disabled=false;
  }catch(e){console.error(e);DOM.walletStatus.textContent="Connection failed";DOM.walletStatus.className="status error";}
  finally{DOM.connectBtn.disabled=false;}
};

// ===== UI å¡«å…… =====
function populateChainsAndTokens(){
  CHAINS.forEach(c=>{let o=document.createElement('option');o.value=c.id;o.textContent=c.name;DOM.fromChain.appendChild(o);});
  CHAINS.forEach(c=>{let o=document.createElement('option');o.value=c.id;o.textContent=c.name;DOM.toChain.appendChild(o);});
  Object.keys(TOKENS).forEach(t=>{let o=document.createElement('option');o.value=t;o.textContent=t;DOM.tokenSelect.appendChild(o);});
}

// ===== Balance =====
async function updateBalance(){if(!account||!signer) return "--"; try{tokenContract=new ethers.Contract(TOKENS[DOM.tokenSelect.value],["function balanceOf(address) view returns (uint256)"],signer);const bal=await tokenContract.balanceOf(account);const f=parseFloat(ethers.utils.formatEther(bal)).toFixed(4);DOM.tokenBalance.textContent=`Balance: ${f} ${DOM.tokenSelect.value}`;return f;}catch(e){DOM.tokenBalance.textContent="Balance: --";return "--";}}

// ===== AI æ›´æ–° =====
async function updateAI(){const bal=await updateBalance();const data={account,balance:bal,amount:DOM.amount.value||0,from:DOM.fromChain.value,to:DOM.toChain.value,slippage:DOM.slippage.value};const report=await bridgeAI.runCheck(data);showAI(report);}
[DOM.tokenSelect,DOM.fromChain,DOM.toChain,DOM.amount,DOM.slippage].forEach(el=>el.addEventListener('input',updateAI));

// ===== NFT & KYC =====
async function updateNFTandKYC(){
  if(!account) return;
  try{
    const resp=await fetch(`${API_BASE}/status`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({address:account})});
    const data=await resp.json();
    DOM.rewardList.textContent=`NFT Rewards: ${data.nfts?.join(", ")||"None"}`;
    DOM.kycStatus.textContent=`KYC: ${data.kycStatus||"Not Verified"}`;
  }catch(e){DOM.rewardList.textContent="NFT Rewards: --"; DOM.kycStatus.textContent="KYC: --";}
}

// ===== ç«ç®­åŠ¨ç”» =====
function launchRocket(){DOM.rocket.classList.add('launch'); setTimeout(()=>DOM.rocket.classList.remove('launch'),2500);}

// ===== Bridge Button =====
DOM.bridgeBtn.onclick=async()=>{
  const amt=parseFloat(DOM.amount.value), slip=parseFloat(DOM.slippage.value), from=DOM.fromChain.value, to=DOM.toChain.value;
  if(!amt||amt<=0){DOM.status.textContent="Invalid amount";DOM.status.className="status error";return;}
  if(from===to){DOM.status.textContent="Select different chains";DOM.status.className="status error";return;}
  const bal=parseFloat(await updateBalance());
  if(amt>bal){DOM.status.textContent="Insufficient balance";DOM.status.className="status error";return;}
  txQueue.push({token:DOM.tokenSelect.value,from,to,amount:amt,slippage:slip,retries:0});
  updateQueueList(); if(txQueue.length===1) processQueue();
};

// ===== äº¤æ˜“é˜Ÿåˆ—å¤„ç† =====
async function processQueue(){
  if(txQueue.length===0) return;
  const tx=txQueue[0]; DOM.bridgeBtn.disabled=true; launchRocket(); DOM.status.textContent=`Processing ${tx.amount} ${tx.token}...`; DOM.status.className="status warn";
  try{
    const resp=await fetch(`${API_BASE}/bridge`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({fromChain:tx.from,toChain:tx.to,token:tx.token,amount:tx.amount,address:account,slippage:DOM.slippage.value})});
    const data=await resp.json(); if(!data.success) throw new Error(data.message||"Server error");

    if(!txChart) initChart();
    txChart.data.labels.push(new Date().toLocaleTimeString());
    txChart.data.datasets[0].data.push(data.estimatedFee||0);
    if(txChart.data.labels.length>20){txChart.data.labels.shift(); txChart.data.datasets[0].data.shift();}
    txChart.update();

    points+=1; txHistory.unshift(tx); updateQueueList(); updateHistoryList(); DOM.pointsInfo.textContent=`Points: ${points}`;
    DOM.status.textContent=`Transfer success! Points: ${points}`; DOM.status.className="status success";

    await updateNFTandKYC(); await updateBalance(); await updateAI();

    txQueue.shift();
  }catch(e){
    if(tx.retries<3){tx.retries+=1; DOM.status.textContent=`Retrying... (${tx.retries})`; DOM.status.className="status warn"; setTimeout(()=>processQueue(),2000); return;}
    DOM.status.textContent="Error: "+e.message.slice(0,60); DOM.status.className="status error"; txQueue.shift();
  }finally{DOM.bridgeBtn.disabled=false;}
  if(txQueue.length>0) setTimeout(()=>processQueue(),500);
}

// ===== å›¾è¡¨ =====
function initChart(){
  const ctx=DOM.txChart.getContext('2d');
  txChart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[{label:'Fee (USD)',data:[],borderColor:'#FF8C00',backgroundColor:'rgba(255,140,0,0.1)',fill:true,tension:0.4}]},options:{responsive:true,plugins:{legend:{labels:{color:'#fff'}}},scales:{x:{grid:{color:'rgba(255,255,255,0.1)'},ticks:{color:'#fff'}},y:{grid:{color:'rgba(255,255,255,0.1)'},ticks:{color:'#fff'}}}}});
}

// ===== åˆ—è¡¨åˆ·æ–° =====
function updateQueueList(){DOM.queueList.textContent=`Queue: ${txQueue.map(t=>`${t.token} ${t.amount} ${t.from}â†’${t.to}`).join(" | ")||"Empty"}`;}
function updateHistoryList(){DOM.historyList.textContent=`History: ${txHistory.slice(0,5).map(t=>`${t.token} ${t.amount} ${t.from}â†’${t.to}`).join(" | ")||"Empty"}`;}
</script>
</body>
</html>

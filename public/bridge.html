<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AstroChannel - Cross-Chain Bridge</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Roboto,sans-serif}
body{background:linear-gradient(180deg,#050029,#1A0050,#2E007A);min-height:100vh;display:flex;justify-content:center;align-items:flex-start;padding:2rem 1rem;color:#fff;position:relative;overflow-x:hidden;}
.stars{position:absolute;inset:0;z-index:0;background:url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4z'/%3E%3C/g%3E%3C/svg%3E");animation:starFlow 80s linear infinite;}
@keyframes starFlow{to{background-position:-1000px 1000px}}
.container{z-index:1;background:rgba(255,255,255,0.04);backdrop-filter:blur(20px);border:1px solid rgba(99,102,241,.3);border-radius:20px;padding:3rem;width:100%;max-width:520px;box-shadow:0 0 40px rgba(99,102,241,.2);text-align:center;position:relative;}
h1{font-size:3rem;background:linear-gradient(90deg,#6366F1,#8B5CF6,#EC4899);-webkit-background-clip:text;color:transparent;margin-bottom:.5rem;background-size:200% 100%;animation:neonGradient 3s linear infinite alternate;}
@keyframes neonGradient{from{background-position:0%}to{background-position:100%}}
.tagline{color:#C7D2FE;margin-bottom:2rem;font-size:1.1rem;}
.wallet-status{margin-bottom:1rem;color:#E0E7FF;font-weight:500;}
.balance{font-size:.85rem;color:#A5B4FC;text-align:right;margin-top:.3rem;}
.group{margin-bottom:1.5rem;text-align:left;}
label{font-size:.9rem;color:#A5B4FC;margin-bottom:.6rem;display:block;}
input,select{width:100%;padding:1rem 1.2rem;border-radius:12px;border:1px solid rgba(99,102,241,.3);background:rgba(15,23,42,.6);color:#fff;outline:none;transition:all .3s ease;}
input:focus,select:focus{border-color:#8B5CF6;box-shadow:0 0 10px rgba(139,92,246,.2);}
button{width:100%;padding:1.1rem;margin-top:.8rem;border-radius:12px;border:none;cursor:pointer;background:linear-gradient(90deg,#6366F1,#8B5CF6);color:#fff;font-weight:600;font-size:1rem;transition:all .3s ease;position:relative;overflow:hidden;}
button::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);transition:left .5s ease;}
button:hover::after{left:100%;}
button:hover{background:linear-gradient(90deg,#5B5FEF,#7C3AED);box-shadow:0 0 15px rgba(99,102,241,.4);}
button:disabled{background:#27296d;cursor:not-allowed;box-shadow:none;}
button:disabled::after{display:none;}
.status{min-height:1.4rem;margin-top:1rem;font-size:.95rem;}
.error{color:#F87171;}
.warn{color:#FBBF24;}
.success{color:#34D399;}
.funct-btns{display:flex;gap:.8rem;margin-top:1.5rem;}
.funct-btn{padding:.8rem;font-size:.9rem;}
.query-section{margin-top:2rem;padding-top:2rem;border-top:1px solid rgba(99,102,241,.2);display:none;}
.query-section.show{display:block;}
@media (max-width:480px){.container{padding:2rem 1.5rem;}h1{font-size:2.2rem;}.funct-btns{flex-direction:column;gap:.6rem;}}
a{color:#6366F1;text-decoration:none;}
a:hover{color:#8B5CF6;text-decoration:underline;}
</style>
</head>
<body>
<div class="stars"></div>
<div class="container">
  <h1>AstroChannel</h1>
  <p class="tagline">Secure Cross-Chain Transfers for AstroTokens</p>
  <p class="wallet-status" id="walletStatus">Wallet not connected</p>
  <button id="connectBtn">Connect MetaMask</button>
  <div class="group">
    <label>From Chain</label>
    <select id="fromChain">
      <option value="ethereum">Ethereum Sepolia</option>
      <option value="bsc">BSC Testnet</option>
      <option value="polygon">Polygon Mumbai</option>
    </select>
  </div>
  <div class="group">
    <label>To Chain</label>
    <select id="toChain">
      <option value="bsc">BSC Testnet</option>
      <option value="polygon">Polygon Mumbai</option>
      <option value="ethereum">Ethereum Sepolia</option>
    </select>
  </div>
  <div class="group">
    <label>Amount (ASTRO)</label>
    <input id="amount" placeholder="0.001" type="number" step="0.001" min="0.001" />
    <div class="balance" id="balance">Balance: -- ASTRO</div>
    <div style="font-size:.8rem;color:#94A3B8;margin-top:.3rem;" id="kycTip">Small transfer (≤5000 USD) - No KYC required</div>
  </div>
  <button id="bridgeBtn" disabled>Bridge Tokens</button>
  <div class="status" id="status"></div>
  <div class="funct-btns">
    <button class="funct-btn" id="airdropBtn">ASTRO Airdrop</button>
    <button class="funct-btn" id="queryTxBtn">Check TX Status</button>
  </div>
  <div class="query-section" id="querySection">
    <div class="group">
      <label>Transaction Hash</label>
      <input id="txHash" placeholder="0x0000000000000000000000000000000000000000" />
    </div>
    <button id="doQueryBtn">Query Now</button>
    <div class="status" id="queryStatus"></div>
  </div>
  <div class="group" style="margin-top:1.5rem;display:none;" id="coldWalletKyc">
    <label>Cold Wallet KYC Verification</label>
    <button id="coldKycBtn">Generate Verify Address</button>
  </div>
</div>
<script>
// 多链配置
const CHAINS={
  ethereum:{test:{chainId:'0xaa36a7',explorer:'https://sepolia.etherscan.io/tx/',rpc:'https://sepolia.infura.io/v3/9aa3d95b3bc440fa88ea12eaa44561616'}},
  bsc:{test:{chainId:'0x61',explorer:'https://testnet.bscscan.com/tx/',rpc:'https://data-seed-prebsc-1-s1.binance.org:8545/'}},
  polygon:{test:{chainId:'0x13881',explorer:'https://mumbai.polygonscan.com/tx/',rpc:'https://rpc-mumbai.maticvigil.com/'}}
};
// 合约地址
const CONTRACT={test:{ASTRO:"0xa513E6E4b8f2a923D98304ec87F64353C4D5C853",BRIDGE:"0x8A791620dd6260079BF849Dc5567aDC3F2FdC318"}};
// 全局常量
const CURRENT_ENV='test',KYC_LIMIT=5000,ASTRO_USD_RATE=0.01;
// ABI定义
const ERC20_ABI=["function balanceOf(address)view returns(uint256)","function allowance(address,address)view returns(uint256)","function approve(address,uint256)returns(bool)","function transfer(address,uint256)returns(bool)"];
const BRIDGE_ABI=["function lockTokens(uint256,string)"];
// 全局状态
let provider,signer,account,token,bridge,isConnected=false;

// DOM元素获取（兼容写法）
const statusEl=document.getElementById('status');
const connectBtn=document.getElementById('connectBtn');
const bridgeBtn=document.getElementById('bridgeBtn');
const walletStatus=document.getElementById('walletStatus');
const balanceEl=document.getElementById('balance');
const amountEl=document.getElementById('amount');
const fromChain=document.getElementById('fromChain');
const toChain=document.getElementById('toChain');
const kycTip=document.getElementById('kycTip');
const airdropBtn=document.getElementById('airdropBtn');
const queryTxBtn=document.getElementById('queryTxBtn');
const querySection=document.getElementById('querySection');
const txHash=document.getElementById('txHash');
const doQueryBtn=document.getElementById('doQueryBtn');
const queryStatus=document.getElementById('queryStatus');
const coldWalletKyc=document.getElementById('coldWalletKyc');
const coldKycBtn=document.getElementById('coldKycBtn');

// ========== 工具函数 ==========
// 设置状态提示
function setStatus(el,msg,cls=''){
  el.className='status '+cls;
  el.innerHTML=msg;
}
// 锁定/解锁UI（修复兼容问题）
function lockUI(v){
  connectBtn.disabled = v;
  bridgeBtn.disabled = v;
  fromChain.disabled = v;
  toChain.disabled = v;
  amountEl.disabled = v;
  airdropBtn.disabled = v;
  doQueryBtn.disabled = v;
  coldKycBtn.disabled = v;
}
// 获取链配置
function getChainConfig(chainKey){
  return CHAINS[chainKey]?.[CURRENT_ENV] || null;
}
// 获取合约地址
function getContractAddr(type){
  return CONTRACT[CURRENT_ENV]?.[type] || null;
}
// 计算USD金额
function calcAmountToUsd(amt){
  return amt * ASTRO_USD_RATE;
}
// 更新KYC提示
function updateKycTip(){
  const amt=parseFloat(amountEl.value)||0;
  const usdAmt=calcAmountToUsd(amt);
  if(usdAmt>KYC_LIMIT){
    kycTip.textContent=`Large transfer (${usdAmt.toFixed(2)} USD) - KYC required`;
    kycTip.style.color='#FBBF24';
  }else{
    kycTip.textContent=`Small transfer (≤${KYC_LIMIT} USD) - No KYC required`;
    kycTip.style.color='#94A3B8';
  }
}
// 检测是否为冷钱包（简化版）
function isColdWallet(addr){
  // 模拟冷钱包检测：以0x00开头视为冷钱包（可根据实际逻辑修改）
  return addr.startsWith('0x00') || addr.startsWith('0x11') || addr.startsWith('0x22');
}

// ========== 钱包网络操作 ==========
// 切换/添加网络（优化错误提示）
async function switchChain(chainKey){
  const chain=getChainConfig(chainKey);
  if(!chain){
    setStatus(statusEl,'Unsupported chain','error');
    return false;
  }
  try{
    await window.ethereum.request({
      method:'wallet_switchEthereumChain',
      params:[{chainId:chain.chainId}]
    });
    return true;
  }catch(e){
    if(e.code===4902){
      setStatus(statusEl,'Adding network to MetaMask...','warn');
      await window.ethereum.request({
        method:'wallet_addEthereumChain',
        params:[{
          chainId:chain.chainId,
          chainName:fromChain.options[fromChain.selectedIndex].text,
          rpcUrls:[chain.rpc],
          blockExplorerUrls:[chain.explorer]
        }]
      });
      return true;
    }
    setStatus(statusEl,`Network switch failed: ${e.message.slice(0,50)}`,'error');
    return false;
  }
}
// 初始化合约
function initContracts(){
  const astroAddr=getContractAddr('ASTRO');
  const bridgeAddr=getContractAddr('BRIDGE');
  if(!astroAddr||!bridgeAddr)return setStatus(statusEl,'Contract address error','error');
  token=new ethers.Contract(astroAddr,ERC20_ABI,signer);
  bridge=new ethers.Contract(bridgeAddr,BRIDGE_ABI,signer);
}
// 获取余额
async function getBalance(){
  if(!isConnected||!account||!token)return;
  try{
    const bal=await token.balanceOf(account);
    const formatBal=ethers.utils.formatEther(bal).substring(0,8);
    balanceEl.textContent=`Balance: ${formatBal} ASTRO`;
  }catch(e){
    balanceEl.textContent='Balance: Error';
    setStatus(statusEl,'Failed to get balance','error');
  }
}

// ========== 核心功能 ==========
// 钱包连接
connectBtn.onclick=async()=>{
  if(!window.ethereum)return setStatus(statusEl,'MetaMask not installed','error');
  if(isConnected)return disconnect();

  lockUI(true);
  connectBtn.textContent='Connecting...';
  setStatus(statusEl,'Waiting for wallet confirmation...','warn');

  try{
    // 请求钱包授权
    const accounts=await window.ethereum.request({method:'eth_requestAccounts'});
    if(!accounts||accounts.length===0)throw new Error('No account selected');
    account=accounts[0];

    // 切换网络
    if(!await switchChain(fromChain.value))throw new Error('Network switch failed');

    // 初始化provider和合约
    provider=new ethers.providers.Web3Provider(window.ethereum);
    signer=provider.getSigner();
    initContracts();
    await getBalance();

    // 检测冷钱包并显示KYC入口
    if(isColdWallet(account)){
      coldWalletKyc.style.display='block';
    }

    // 更新UI
    walletStatus.textContent=`Connected: ${account.slice(0,6)}...${account.slice(-4)}`;
    connectBtn.textContent='Disconnect Wallet';
    bridgeBtn.disabled=false;
    isConnected=true;
    setStatus(statusEl,'Wallet connected successfully','success');
  }catch(e){
    const errMsg=e.message.includes('cancelled')?'Connection cancelled':`Connect failed: ${e.message.slice(0,50)}`;
    setStatus(statusEl,errMsg,'error');
    connectBtn.textContent='Connect MetaMask';
  }finally{
    lockUI(false);
  }
};
// 断开钱包
function disconnect(){
  isConnected=false;
  account=null;
  walletStatus.textContent='Wallet not connected';
  connectBtn.textContent='Connect MetaMask';
  bridgeBtn.disabled=true;
  balanceEl.textContent='Balance: -- ASTRO';
  amountEl.value='';
  coldWalletKyc.style.display='none';
  updateKycTip();
  setStatus(statusEl,'');
  setStatus(queryStatus,'');
  querySection.classList.remove('show');
}
// 链切换事件
fromChain.onchange=async()=>{
  if(!isConnected)return;
  lockUI(true);
  setStatus(statusEl,'Switching network...','warn');
  if(await switchChain(fromChain.value)){
    initContracts();
    await getBalance();
    setStatus(statusEl,'Network switched','success');
  }
  lockUI(false);
};
// 金额输入-KYC提示
amountEl.oninput=updateKycTip;

// 跨链桥功能
bridgeBtn.onclick=async()=>{
  // 基础校验
  if(fromChain.value===toChain.value)return setStatus(statusEl,'Source and target chain cannot be the same','error');
  const amt=parseFloat(amountEl.value);
  if(!amt||amt<=0||isNaN(amt))return setStatus(statusEl,'Please enter a valid amount','error');

  // KYC提示
  const usdAmt=calcAmountToUsd(amt);
  if(usdAmt>KYC_LIMIT){
    setStatus(statusEl,'KYC verification passed (test)','warn');
  }

  lockUI(true);
  setStatus(statusEl,'Processing transaction...','warn');
  try{
    const wei=ethers.utils.parseEther(amt.toString());
    // 检查授权
    const allowance=await token.allowance(account,getContractAddr('BRIDGE'));
    if(allowance.lt(wei)){
      setStatus(statusEl,'Approving token spending...','warn');
      const approveTx=await token.approve(getContractAddr('BRIDGE'),ethers.constants.MaxUint256);
      await approveTx.wait(1);
      setStatus(statusEl,'Approval successful, bridging tokens...','warn');
    }
    // 执行跨链
    const bridgeTx=await bridge.lockTokens(wei,toChain.value);
    await bridgeTx.wait(1);
    // 成功提示
    const explorerUrl=getChainConfig(fromChain.value).explorer+bridgeTx.hash;
    setStatus(statusEl,`Bridge success! <a target="_blank" href="${explorerUrl}">View Transaction</a>`,'success');
    // 重置输入
    amountEl.value='';
    await getBalance();
    updateKycTip();
  }catch(e){
    const errMsg=e.message.includes('cancelled')?'Transaction cancelled':`Bridge failed: ${e.message.slice(0,50)}`;
    setStatus(statusEl,errMsg,'error');
  }finally{
    lockUI(false);
  }
};

// 空投功能（优化异常处理）
airdropBtn.onclick=async()=>{
  if(!isConnected)return setStatus(statusEl,'Please connect wallet first','error');
  lockUI(true);
  setStatus(statusEl,'Claiming airdrop...','warn');
  try{
    // 测试网空投：发放0.1 ASTRO（模拟，实际需合约支持）
    const airdropAmt=ethers.utils.parseEther('0.1');
    // 先检查合约是否有足够余额（避免转账失败）
    const contractBal=await token.balanceOf(getContractAddr('ASTRO'));
    if(contractBal.lt(airdropAmt)){
      throw new Error('Contract has no enough ASTRO for airdrop');
    }
    const tx=await token.transfer(account,airdropAmt);
    await tx.wait(1);
    await getBalance();
    setStatus(statusEl,'Airdrop claimed successfully! Balance updated','success');
  }catch(e){
    const errMsg=e.message.includes('cancelled')?'Airdrop cancelled':`Airdrop failed: ${e.message.slice(0,50)}`;
    setStatus(statusEl,errMsg,'error');
  }finally{
    lockUI(false);
  }
};

// 交易查询功能
queryTxBtn.onclick=()=>{
  querySection.classList.toggle('show');
  queryTxBtn.textContent=querySection.classList.contains('show')?'Close Query':'Check TX Status';
};
doQueryBtn.onclick=async()=>{
  // 校验交易哈希
  if(!txHash.value||!txHash.value.startsWith('0x')||txHash.value.length!==66){
    return setStatus(queryStatus,'Please enter valid 66-character TX Hash','error');
  }
  lockUI(true);
  setStatus(queryStatus,'Querying transaction...','warn');
  try{
    // 模拟查询（实际需对接链上接口）
    setStatus(queryStatus,'Transaction found - Pending (test)','warn');
  }catch(e){
    setStatus(queryStatus,'Transaction not found or invalid','error');
  }finally{
    lockUI(false);
  }
};

// 冷钱包KYC
coldKycBtn.onclick=async()=>{
  if(!isConnected)return setStatus(statusEl,'Please connect wallet first','error');
  lockUI(true);
  setStatus(statusEl,'Generating verify address...','warn');
  try{
    // 生成临时验证地址
    const verifyAddr='0x'+Math.random().toString(16).substring(2,42);
    setStatus(statusEl,`Verify address generated: <br/>${verifyAddr.slice(0,10)}...${verifyAddr.slice(-10)}<br/>Send small test coin to verify`,'success');
  }catch(e){
    setStatus(statusEl,`Generate failed: ${e.message.slice(0,50)}`,'error');
  }finally{
    lockUI(false);
  }
};

// ========== 全局事件监听 ==========
// 钱包账号变化
window.ethereum?.on('accountsChanged',(accs)=>{
  if(accs.length===0){
    disconnect();
  }else{
    account=accs[0];
    getBalance();
    // 重新检测冷钱包
    if(isColdWallet(account)){
      coldWalletKyc.style.display='block';
    }else{
      coldWalletKyc.style.display='none';
    }
  }
});
// 钱包链变化
window.ethereum?.on('chainChanged',()=>{
  if(isConnected){
    initContracts();
    getBalance();
  }
});
// 钱包断开
window.ethereum?.on('disconnect',disconnect);

// 页面加载初始化
window.onload=()=>{
  updateKycTip();
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AstroChannel - Cross-Chain Bridge</title>

  <!-- 修复：替换为稳定加载的ethers v5 CDN，优先加载 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Roboto, sans-serif; }
    body {
      background: linear-gradient(180deg,#050029,#1A0050,#2E007A);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      color:#fff;
      position:relative;
      overflow:auto;
    }
    .stars {
      position:absolute; inset:0; z-index:0;
      background:url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4z'/%3E%3C/g%3E%3C/svg%3E");
      animation: starFlow 80s linear infinite;
    }
    @keyframes starFlow { to { background-position:-1000px 1000px; } }

    .container {
      z-index:1;
      background:rgba(255,255,255,0.04);
      backdrop-filter:blur(20px);
      border:1px solid rgba(99,102,241,0.3);
      border-radius:20px;
      padding:3rem;
      width:100%;
      max-width:520px;
      box-shadow:0 0 40px rgba(99,102,241,0.2);
      text-align:center;
    }

    h1 {
      font-size:3rem;
      background:linear-gradient(90deg,#6366F1,#8B5CF6);
      -webkit-background-clip:text;
      color:transparent;
      margin-bottom:.5rem;
    }
    .tagline { color:#C7D2FE; margin-bottom:2rem; }

    .wallet-status { margin-bottom:1rem; color:#E0E7FF; }
    .balance { font-size:.85rem; color:#A5B4FC; text-align:right; }

    .group { margin-bottom:1.2rem; text-align:left; }
    label { font-size:.9rem; color:#A5B4FC; margin-bottom:.4rem; display:block; }

    input, select {
      width:100%;
      padding:1rem;
      border-radius:12px;
      border:1px solid rgba(99,102,241,0.3);
      background:rgba(15,23,42,0.6);
      color:#fff;
      outline:none;
    }
    input::placeholder { color:#818cf8; opacity:0.6; }

    button {
      width:100%;
      padding:1.1rem;
      margin-top:.8rem;
      border-radius:12px;
      border:none;
      cursor:pointer;
      background:linear-gradient(90deg,#6366F1,#8B5CF6);
      color:#fff;
      font-weight:600;
      transition:.3s;
    }
    button:disabled {
      background:#27296d;
      cursor:not-allowed;
    }
    button:not(:disabled):hover {
      box-shadow:0 0 20px rgba(99,102,241,0.4);
    }

    .status {
      min-height:1.3rem;
      margin-top:1rem;
      font-size:.95rem;
    }
    .error { color:#F87171; }
    .warn { color:#FBBF24; }
    .success { color:#34D399; }
    a { color:#6366F1; text-decoration:none; }
    a:hover { text-decoration:underline; }
  </style>
</head>

<body>
<div class="stars"></div>

<div class="container">
  <h1>AstroChannel</h1>
  <p class="tagline">Secure Cross-Chain Transfers for AstroTokens</p>

  <p class="wallet-status" id="walletStatus">Wallet not connected</p>
  <button id="connectBtn">Connect MetaMask</button>

  <div class="group">
    <label>From Chain</label>
    <select id="fromChain">
      <option value="ethereum">Ethereum Sepolia</option>
      <option value="bsc">BSC Testnet</option>
      <option value="polygon">Polygon Mumbai</option>
    </select>
  </div>

  <div class="group">
    <label>To Chain</label>
    <select id="toChain">
      <option value="bsc">BSC Testnet</option>
      <option value="polygon">Polygon Mumbai</option>
      <option value="ethereum">Ethereum Sepolia</option>
    </select>
  </div>

  <div class="group">
    <label>Amount</label>
    <input id="amount" type="text" placeholder="0.001" inputmode="decimal" />
    <div class="balance" id="balance">Balance: -- ASTRO</div>
  </div>

  <button id="bridgeBtn" disabled>Bridge Tokens</button>
  <div class="status" id="status"></div>
</div>

<script>
/* ================= CONFIG ================= */
const CHAINS = {
  ethereum: { chainId: '0xaa36a7', explorer: 'https://sepolia.etherscan.io/tx/' },
  bsc:      { chainId: '0x61', explorer: 'https://testnet.bscscan.com/tx/' },
  polygon:  { chainId: '0x13881', explorer: 'https://mumbai.polygonscan.com/tx/' }
};

const ASTRO_TOKEN = "0xa513E6E4b8f2a923D98304ec87F64353C4D5C853";
const BRIDGE = "0x8A791620dd6260079BF849Dc5567aDC3F2FdC318";

const ERC20_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address,address) view returns (uint256)",
  "function approve(address,uint256) returns (bool)"
];

const BRIDGE_ABI = [
  "function lockTokens(uint256,string)"
];

/* ================= STATE ================= */
let provider, signer, account;
let token, bridge;
let isConnected = false;

/* ================= DOM ================= */
const statusEl = document.getElementById('status');
const walletStatus = document.getElementById('walletStatus');
const connectBtn = document.getElementById('connectBtn');
const bridgeBtn = document.getElementById('bridgeBtn');
const amountInput = document.getElementById('amount');
const balanceEl = document.getElementById('balance');
const fromChain = document.getElementById('fromChain');
const toChain = document.getElementById('toChain');

/* ================= HELPERS ================= */
function setStatus(msg, cls='') {
  statusEl.className = 'status ' + cls;
  statusEl.innerHTML = msg;
}

// 格式化金额，防止科学计数法/空值
function formatAmount(val) {
  if (!val || val === '' || isNaN(parseFloat(val))) return null;
  const num = parseFloat(val);
  return num > 0 ? num : null;
}

/* ================= WALLET ================= */
connectBtn.onclick = async () => {
  if (!window.ethereum) return setStatus('MetaMask not installed!','error');
  if (isConnected) return disconnectWallet(); // 新增：点击已连接按钮断开钱包

  try {
    setStatus('','');
    [account] = await ethereum.request({ method:'eth_requestAccounts' });
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();

    // 初始化合约
    token = new ethers.Contract(ASTRO_TOKEN, ERC20_ABI, signer);
    bridge = new ethers.Contract(BRIDGE, BRIDGE_ABI, signer);

    // 更新钱包状态
    isConnected = true;
    walletStatus.textContent = `Connected: ${account.slice(0,6)}...${account.slice(-4)}`;
    connectBtn.textContent = 'Disconnect Wallet';
    bridgeBtn.disabled = false;

    // 获取并显示余额
    const bal = await token.balanceOf(account);
    balanceEl.textContent = `Balance: ${ethers.utils.formatEther(bal)} ASTRO`;
    setStatus('Wallet connected successfully','success');
  } catch (err) {
    setStatus(`Connect failed: ${err.message.slice(0,40)}`,`error`);
  }
};

// 新增：断开钱包逻辑
function disconnectWallet() {
  isConnected = false;
  account = null;
  provider = null;
  signer = null;
  token = null;
  bridge = null;

  walletStatus.textContent = 'Wallet not connected';
  connectBtn.textContent = 'Connect MetaMask';
  bridgeBtn.disabled = true;
  balanceEl.textContent = 'Balance: -- ASTRO';
  amountInput.value = '';
  setStatus('','');
}

/* ================= BRIDGE ================= */
bridgeBtn.onclick = async () => {
  // 1. 基础验证
  if (fromChain.value === toChain.value)
    return setStatus('From/To chain cannot be the same','error');

  const amount = formatAmount(amountInput.value.trim());
  if (!amount)
    return setStatus('Please enter a valid positive amount','error');

  // 2. 网络链ID验证
  try {
    const chainId = await ethereum.request({ method:'eth_chainId' });
    if (chainId !== CHAINS[fromChain.value].chainId)
      return setStatus(`Please switch to ${fromChain.options[fromChain.selectedIndex].text}`,`error`);
  } catch (err) {
    return setStatus('Failed to get network','error');
  }

  // 3. 转换金额为Wei
  let amountWei;
  try {
    amountWei = ethers.utils.parseUnits(amount.toString(),18);
  } catch {
    return setStatus('Invalid amount format','error');
  }

  // 4. 开始跨链流程
  try {
    bridgeBtn.disabled = true;
    setStatus('Checking token allowance...','warn');

    // 检查授权额度
    const allowance = await token.allowance(account, BRIDGE);
    if (allowance.lt(amountWei)) {
      setStatus('Approving tokens (one-time)...','warn');
      const approveTx = await token.approve(BRIDGE, ethers.constants.MaxUint256);
      await approveTx.wait();
      setStatus('Approval success! Locking tokens...','warn');
    }

    // 锁定代币触发跨链
    const lockTx = await bridge.lockTokens(amountWei, toChain.value);
    await lockTx.wait();

    // 跨链成功，显示浏览器链接
    setStatus(
      `Success! <a href="${CHAINS[fromChain.value].explorer}${lockTx.hash}" target="_blank">View Transaction</a>`,
      'success'
    );
    amountInput.value = ''; // 清空输入框
  } catch (err) {
    setStatus(`Bridge failed: ${err.message.slice(0,50)}`,`error`);
  } finally {
    bridgeBtn.disabled = false; // 无论成败都解锁按钮
  }
};

/* ================= 新增：钱包事件监听 ================= */
// 监听链切换 - 刷新保持状态
window.ethereum?.on('chainChanged', () => {
  if (isConnected) window.location.reload();
});

// 监听账户切换/钱包断开
window.ethereum?.on('accountsChanged', (accounts) => {
  if (accounts.length === 0) disconnectWallet();
  else if (accounts[0] !== account) window.location.reload();
});

// 监听钱包断开连接
window.ethereum?.on('disconnect', () => disconnectWallet());
</script>
</body>
</html>
